\documentclass[letterpaper,final,12pt,reqno]{amsart}

\usepackage[total={6.3in,9.2in},top=1.1in,left=1.1in]{geometry}

\usepackage{bm}
\usepackage{empheq}
\usepackage[dvipsnames]{xcolor}
\usepackage{graphicx}
\usepackage{verbatim,fancyvrb}
\usepackage{tikz}
\usepackage{times}

% hyperref should be the last package we load
\usepackage[pdftex,
colorlinks=true,
plainpages=false, % only if colorlinks=true
linkcolor=blue,   % only if colorlinks=true
citecolor=Red,   % only if colorlinks=true
urlcolor=black     % only if colorlinks=true
]{hyperref}

\renewcommand{\baselinestretch}{1.05}

\newcommand{\ddt}[1]{\ensuremath{\frac{\partial #1}{\partial t}}}
\newcommand{\ddx}[1]{\ensuremath{\frac{\partial #1}{\partial x}}}
\newcommand{\ddy}[1]{\ensuremath{\frac{\partial #1}{\partial y}}}
\newcommand{\pp}[2]{\ensuremath{\frac{\partial #1}{\partial #2}}}
\renewcommand{\t}[1]{\texttt{#1}}
\newcommand{\Matlab}{\textsc{Matlab}\xspace}
\newcommand{\eps}{\epsilon}
\newcommand{\RR}{\mathbb{R}}

\newcommand{\grad}{\nabla}
\newcommand{\Div}{\nabla\cdot}
\newcommand{\trace}{\operatorname{tr}}

\newcommand{\hbn}{\hat{\mathbf{n}}}

\newcommand{\bg}{\mathbf{g}}
\newcommand{\bn}{\mathbf{n}}
\newcommand{\bu}{\mathbf{u}}
\newcommand{\bv}{\mathbf{v}}
\newcommand{\bx}{\mathbf{x}}

\newcommand{\bX}{\mathbf{X}}

\newcommand{\bzero}{\bm{0}}

\newtheorem{lemma}{Lemma}


\begin{document}
\title[High-performance evolving-geometry glacier flow simulations]{High-performance evolving-geometry glacier flow simulations using Stokes dynamics}

\author{Ed Bueler}

\maketitle

\thispagestyle{empty}
\bigskip

\section{Introduction} \label{sec:intro}

Evolving-geometry simulations are widely used by scientists to understand the size and extent of, and climate-related changes in, glaciers and ice sheets.  The relationship between surface mass inputs and the geometry of the ice mass is important because glacier geometry affects sea level, fresh water supplies for communities and agriculture, and deformations of the Earth's crust, among other concerns.

A variety of methodologies for such numerical simulations are used in practice, with most of the well-established schemes involving signicant shallowness approximations in the continuum equations \cite[for example]{Hoffmanetal2018,Lipscombetal2019,Winkelmannetal2011}.  Furthermore, most methods use explicit or semi-implicit time-stepping, with correspondingly small time steps at high spatial resolution, though (shallow) fully-implicit exceptions exist \cite{Brinkerhoffetal2017,Bueler2016}.  The performance properties of current numerical models tend to limit either the physical modeling authenticity (from shallowness and other approximations) or the spatial resolution (from time-stepping and solver performance limitations).  In particular, the quality of ensemble simulations, both in terms of the number of ensemble members and the quality of the individual simulations, is directly limited by performance properties.

\begin{figure}[h]
\begin{center}
\includegraphics[width=0.7\textwidth]{cartoon.pdf}
\end{center}
\caption{We consider grounded glacier and ice sheet models based on Glen-Stokes ice flow, an evolving free surface, and a free boundary (margin).}
\label{fig:cartoon}
\end{figure}

This paper\footnote{version: \today} addresses an important, but also restricted, class of numerical glacier and ice sheet models which are based on the conservation of momentum and mass within the ice.  For conservation of momentum we use the standard shear-thinning (Glen) power-law Stokes model.  Note that mass conservation refers both to fluid incompressibility and to conservation at the ice surface, namely the surface kinematical equation (or kinematic boundary condition \cite{GreveBlatter2009}).  We consider three-dimensional grounded glaciers and ice sheets for which there is a well-defined ice thickness---overhanging ice is not modeled---but with an evolving free boundary at the ice margin \cite{SchoofHewitt2013}.  The ice thickness is zero in those locations where the (coupled and solved) surface balance and ice flow do not allow a glacier.  Figure \ref{fig:cartoon} sketches our situation.

We do not, however, consider the conservation of energy, that is, thermomechanical coupling or basal melt.  A further restriction is that our ice sticks to the bed (no slip), thus we cannot model floating ice or otherwise sliding bases, and furthermore we only consider cases where the bed elevations are relatively-smooth.  These restrictions are all removable, but doing so will affect model performance in ways which are topics for further research.

To discretize the continuum equations we apply the finite element (FE) method \cite{Elmanetal2014} on unstructured-meshes in the map-plane, through calls to the Firedrake library \cite{Rathgeberetal2016}, and we use stable (e.g.~Taylor-Hood) mixed elements for velocity and pressure.  The nonlinear solutions of the discrete equations is through PETSc \cite{Balayetal2020}, using multigrid-preconditioned Newton-Krylov methods \cite{Bueler2021}.  The relatively-brief new programs used here are open-source Python codes at \href{https://github.com/bueler/stokes-implicit}{\texttt{github.com/bueler/stokes-implicit}}.\footnote{FIXME: MAKE REPO PUBLIC.}

The primary purpose of the paper is to demonstrate high-performance numerical simulations with Glen-Stokes momentum conservation, coupled to the surface kinematical equation at each implicit time step.  Our performance metric, introduced here, is one which practitioners should regard as natural, namely we measure the run time and floating-point operations (flops) of our simulations relative to the well-understood computation of ice velocity in the shallow ice approximation (SIA) on the same mesh.  That is, we define a ``work unit'' as a diagnostic computation of the SIA velocity solution, a mere vertical integration \cite{SchoofHewitt2013}, and we report performance of the Stokes model in these work units.  We WILL validate the model based on results of laboratory-scale experiments, and we WILL demonstrate solver optimality.


\section{Equations for glacier flow and evolution} \label{sec:strongform}

The standard description of the flow of glaciers applies shear-thinning Stokes equations incorporating Glen's flow law for ice \cite{GreveBlatter2009,JouvetRappaz2011,SchoofHewitt2013}.  We will apply this model on time-dependent $d=2$ or $d=3$ dimensional domains using time $t>0$ and spatial variables $\bx=(x,y,z)$, with $z$ vertical.  (Coordinates are $\bx=(x,z)$ in 2D.)  The evolving domain $\Omega^t \subset \RR^d$ must have a piecewise smooth boundary so that we may apply the boundary conditions, but it is otherwise general.

Allowing any Glen exponent $n\ge 1$, the strong form model equations are:
\begin{align}
- \nabla \cdot \tau + \nabla p &= \rho \bg &&\text{\emph{stress balance}} \label{forcebalance} \\
\nabla \cdot \bu &= 0 &&\text{\emph{incompressibility}} \label{incompressible} \\
\tau &= B_n |D\bu|^{(1/n) - 1} D\bu  &&\text{\emph{viscosity-form flow law}} \label{viscflowlaw}
\end{align}
The fields are velocity $\bu$, pressure $p$, deviatoric stress tensor $\tau$, and strain rate tensor $D\bu$.  For simplicity we take the ice density $\rho$ and the acceleration of gravity $\bg=\left<0,0,-g\right>$, with $g>0$, to be constant.  For convenience we allow an optional constant tilt angle $\alpha$ in the $x,z$ plane, so that $\bg = \left<g\sin\alpha,0,-g\cos\alpha\right>$.

Regarding tensors and notation, first recall that $D\bu$ is the symmetric part of $\grad \bu$, i.e.~$(D\bu)_{ij} = \frac{1}{2} \left(\grad\bu + \grad\bu^\top\right)$.  The tensor norm in \eqref{viscflowlaw} satisfies $|D\bu|^2 = \frac{1}{2} \trace\left((D\bu)^2\right) = \frac{1}{2} (D\bu)_{ij} (D\bu)_{ij}$.  The full (Cauchy) stress tensor $\sigma$ is the deviatoric part $\tau$ minus the pressure, i.e.~$\sigma = \tau - p\,I$, and so equation \eqref{forcebalance} simply says $-\Div \sigma = \rho \bg$.  Also $B_n$ is the $n$-dependent \emph{ice hardness} in units $\text{Pa}\,\text{s}^{1/n}$; it is sometimes written $B_n = (A_n)^{-1/n}$ in terms of the \emph{ice softness} $A_n$.  Finally, because $D\bu$ is symmetric, and because it has trace zero by \eqref{incompressible}, i.e.~$\trace(D\bu)=\nabla \cdot \bu = 0$, by equation \eqref{viscflowlaw} the same two properties hold for $\tau$.

For the linear Stokes equations, i.e.~the $n=1$ case, one would traditionally write \eqref{viscflowlaw} as $\tau = 2\nu D\bu$ \cite{Elmanetal2014}, and in that case the viscosity would be $\nu = (1/2) B_1$.  For general $n>1$, namely actual shear-thinning ice, the corresponding ``effective viscosity'' in \eqref{viscflowlaw} involves a negative power of the strain rate magnitudes $|D\bu|$, thus the effective viscosity is singular in the limit of small strain rates.  Motivated by the expected finite viscosity of real ice \cite{GreveBlatter2009}, and by the expectation that the equations using a regularized viscosity will be well-posed and solvable \cite{JouvetRappaz2011}, we define the \emph{regularized effective viscosity}
\begin{equation}
\nu_\eps(|D\bu|) = (1/2) B_n \left(|D\bu|^2 + (\eps D_0)^2\right)^{(p-2)/2} \label{regeffvisc}
\end{equation}
where $\eps = 0.01$, $D_0 = 2 a^{-1}$, and $p=\frac{1}{n}+1$.  The constant $D_0$ defines a typical strain-rate scale for glacier flow; the value here corresponds, for example, to a velocity difference of 1000 meters per year in a distance of 500 meters.

Using \eqref{viscflowlaw}, as modified by \eqref{regeffvisc}, we can eliminate $\tau$ from equation \eqref{forcebalance}, thereby rewriting the system in terms of velocity and pressure only:
\begin{align}
- \nabla \cdot \left(2 \nu_\eps(|D\bu|)\, D\bu\right) + \nabla p &= \rho \mathbf{g} \label{stokes} \\
\Div \bu &= 0 \label{incompagain}
\end{align}
This system is our \emph{Glen-Stokes model}.  A solution is a velocity-pressure pair $(\bu,p)$, from which one may derive the strain rates $D\bu$ and thus the stresses $\tau$ or $\sigma = \tau - p\,I$.

Glacier-suitable velocity and stress boundary conditions will be used, with an emphasis on the case of an isolated glacier (or collection of glaciers), in which the ice flow extends to a free boundary at the glacier margin.\footnote{In real glaciers grounded margins may occur as fracture-generated cliffs, but such are not modeled here.}  As noted, we assume that the base and top boundaries of $\Omega^t$, at each time, can be identified, and we assume that at least the base has positive measure.  On the top surface we set a condition of zero applied stress, i.e.~$\sigma\hbn=0$ where $\hbn$ is the outward normal:
\begin{align}
\left(2 \nu_\eps(|D\bu|) D\bu - pI\right) \hbn &= \bzero  &&\text{\emph{top}: } \overline{\partial} \Omega^t \label{topbc} \\
\intertext{On the base we require no slip:}
\bu &= \bzero  &&\text{\emph{base}: } \underline{\partial} \Omega^t \label{basebc} \\
\intertext{Optionally, to allow simulation of a certain laboratory experiment \cite{SayagWorster2013}, we also allow an inflow boundary on which a prescribed velocity $\bu_{\text{in}}$ is applied:}
\bu &= \bu_{\text{in}}  &&\text{\emph{inflow}: } \partial_{\text{in}} \Omega^t. \label{inflowbc}
\end{align}
We require $\bu_{\text{in}}\cdot \hbn \le 0$ in this case.

Assuming the well-posedness of the above model \eqref{stokes}--\eqref{inflowbc}, proven by \cite{JouvetRappaz2011}, if the ice geometry $\Omega^t$ is known then the solution is a unique pair $(\bu,p)$.  Note that the slowness of the fluid, i.e.~zero Reynolds number, implies that the given boundary stresses and body forces determine velocity and pressure fields without any ``memory'' of prior states or influence from inertia (as would arise in the Navier-Stokes equations).

The above equations do not describe the process by which the glacier changes shape or extent.  This is described by an additional equation which states conservation of mass on the top boundary $\overline{\partial} \Omega^t$.  To present this equation we first assume a larger map-plane computational domain $R\subset \RR^{d-1}$, typically a rectangle for $d=3$ or an interval for $d=2$, on which the data $a,b$ of the problem are defined; see Figure \ref{fig:domainnotation}.  The ice-covered area is then a subset of the interior of $R$; that is, we require that ice is not present on, nor does it flow across, the boundary of $R$.  Thus the following time-dependent form for the domain applies:
\begin{equation}
\Omega^t = \left\{\bx\,\big|\,(x,y)\in R \text{ and } b(x,y) < z < h(x,y,t)\right\}.  \label{Omegat}
\end{equation}
Here $z=b(x,y)$ is the base elevation, assumed time-independent for simplicity, and $z=h(x,y,t)$ is the ice surface elevation.  An admissibility requirement for the function $h(x,y,t)$ as a part of the model solution \cite{Bueler2016}, is that
\begin{equation}
h(x,y,t) \ge b(x,y).  \label{admissibility}
\end{equation}
For a given map-plane location $(x,y)$ the ice may be present $h(x,y,t)>b(x,y)$ or absent $h(x,y,t)=b(x,y)$ in an evolving, time-dependent manner.  Note that both $h$ and $b$ are defined for all $(x,y)\in R$.  The time-dependent ice-covered map-plane domain is the vertical projection of $\Omega^t$, denoted $\pi \Omega^t$.

\begin{figure}[h]
\begin{center}
\includegraphics[width=0.7\textwidth]{domainnotation.pdf}
\end{center}
\caption{Notation: The evolving ice domain $\Omega^t$ has projection $\pi \Omega^t$.  Surface mass balance $a$ and base elevation $b$ are defined on all of $R$.}
\label{fig:domainnotation}
\end{figure}



In agreement with most ice sheet and glacier modeling literature we assume that the top of the ice mass is described by a well-defined surface elevation function $h(x,y,t)$.  This should be acknowledged as a kind of ``proto-shallowness'' assumption, as the domain $\Omega^t$ is not general, but rather is a fluid layer \cite{Bueler2020}, and in particular there are no ice overhangs.  In other words we are assuming that for each map-plane location $(x,y)$ and time $t$ the set
\begin{equation}
I(x,y,t) = \{z\,\big|\,\bx=(x,y,z) \in \Omega^t\} \label{intervalassume}
\end{equation}
is a single (open) real interval.  Note that $I(x,y,t)$ is the empty set when ice is not present at map-plane location $(x,y)$.  Looking ahead, this basic layer assumption is compatible with a numerical scheme based on a more-or-less arbitrary unstructured mesh in the map plane which is then extruded vertically, upward from the base, to cover $\Omega^t$.

Let $a(x,y,z,t)$ be the (modeled) climatic mass balance, in (ice-equivalent) units $\text{m}\,\text{s}^{-1}$, which we assume is prescribed for all locations above the base elevation, i.e.~$(x,y,z) \in R\times[b(x,y),\infty)$, and all times $t>0$.  Denoting the velocity components as $\bu=\left<u,v,w\right>$, the surface kinematical equation \cite{GreveBlatter2009} applies on the top of the ice,\footnote{Modeling melting or freeze-on at the ice base would add a basal kinematic equation \cite{Aschwandenetal2012}.}
    $$h_t = a - u h_x - v h_y + w \quad \text{ on } \overline{\partial}\Omega^t,$$
or, stated somewhat more precisely using vector notation,
\begin{equation}
h_t = a\big|_{z=h} + \bu\big|_{z=h} \cdot \left<-\grad h,1\right> \quad \text{ on } \overline{\partial}\Omega^t. \label{surfacekinematical}
\end{equation}
The surface mass balance entering into this equation, as a source term, is the trace of $a$ along the surface, namely $a\big|_{z=h}=a(x,y,h(x,y,t),t)$.

FIXME surface kinematical is actually an inequality

Informally, \eqref{surfacekinematical} describes how the top surface elevation is updated by using the climatically added or removed ice $a\,\Delta t$, plus the component of the ice motion in the outward (upward) normal direction $\bn = \left<-\grad h,1\right>$.  Note that $a(x,y,z,t)$ is typically computed by a separate model covering the dynamical state of the atmosphere, including snow precipitation and atmospheric energy-driven melt.  (Clearly this topic is well beyond our scope.)  Numerical glacier models often evolve the time-dependent surface $z=h$ by explicit steps, i.e.~$\Delta h \approx \left(a + \bu\cdot \bn\right) \Delta t$ in the simplest forward-Euler case, based upon the current values $a=a\big|_{z=h}$, $\bu= \bu\big|_{z=h}$, and $\grad h$.  However, we will be solving \eqref{surfacekinematical} implicitly, that is, coupled with the Glen-Stokes system \eqref{stokes}--\eqref{inflowbc}.


\section{Decoupled Stokes weak form} \label{sec:weakstokes}

Next we write the weak form for the decoupled problem \eqref{stokes}--\eqref{inflowbc}.  This will set notation, and provide a possibly-familiar starting point \cite[for example]{Bueler2021,Elmanetal2014}, before describing the coupled momentum and mass model in the next section.

Recall $p=1/n + 1>1$, and let $p'=(1-p^{-1})^{-1}=p/(p-1)=n+1\ge 2$ be the conjugate exponent.  The Sobolev space of velocities with first derivatives in $L^p$ is denoted $W^{1,p}(\Omega^t)$ \cite{Evans2010}.  Fix $t>0$.  We will seek a solution from the following spaces:
\begin{align*}
\bu &\in V_D = \left\{\bv \in W^{1,p}(\Omega^t)\,:\,\bv\big|_{\underline{\partial} \Omega^t}=\bzero \text{ and } \bv\big|_{\partial_{\text{in}} \Omega^t} = \bu_{\text{in}}\right\}, \\
p &\in Q =L^{p'}(\Omega^t).
\end{align*}
For the following weak form, test functions $\bv \in V_0$ and $q\in Q$ will come from nearly the same spaces, but with $\bv=\bzero$ on both the base and the inflow boundaries.

To derive the weak form we multiply \eqref{stokes} by $\bv\in V_0$ and \eqref{incompagain} by $q\in Q$, then add these and integrate-by-parts:
\begin{equation}
-\int_{\partial\Omega^t} (\sigma \hbn)\cdot \bv\,dS + \int_{\Omega^t} \tau \,:\,D\bv - p (\nabla \cdot \bv) - \left(\nabla \cdot \bu\right) q - \rho \mathbf{g} \cdot \bv \,d\bx = 0. \label{nonfunctwo}
\end{equation}
Here $dS$ is the arclength element along $\partial\Omega^t$.  Note that $\bu,\bv$ appear with at most first derivatives and $p,q$ appear without derivatives.  Next, because $\bv\in V_0$, portions of the integral over $\partial\Omega^t$ are zero, and the stress-free surface condition then eliminates the boundary integral.  Thus we have the following formula for the nonlinear residual functional $\tilde F$:
\begin{equation}
\tilde F(\bu,p;\bv,q) = \int_{\Omega^t} 2 \nu_\eps(|D\bu|)\, D\bu\,:\,D\bv - p (\nabla \cdot \bv) - \left(\nabla \cdot \bu\right) q - \rho \mathbf{g} \cdot \bv \,d\bx. \label{definetildeF}
\end{equation}
The final integral in \eqref{definetildeF} can be regarded as a source term.

We say $\bu\in V_D$ and $p\in Q$ solve the weak formulation if
\begin{equation}
\tilde F(\bu,p;\bv,q) = 0 \qquad \text{ for all } \bv\in V_0 \text{ and } q\in Q.  \label{weak}
\end{equation}
An equivalent formulation is proved in \cite[Theorem 3.8]{JouvetRappaz2011} to be well-posed under reasonable assumptions about the domain and the boundary data.  Note that if the inflow velocity is zero or absent ($\partial_{\text{in}} \Omega^t = \emptyset$), and if the source term is also zero, for instance because gravity is turned off ($\bg=\bzero$), then the unique solution of \eqref{weak} is $\bu=\bzero$ and $p=0$.


\section{Implicit time-discretization and the icy domain update} \label{sec:implicitstep}

The main purpose of this paper is to propose an implicit domain-updating scheme to simultaneously solve the Glen-Stokes equations and the surface kinematical equation.  In this proposed scheme we compute a greatly-simplified surrogate of the ice strain field during a time step.  This surrogate, a vertical-only displacement value defined everywhere within the current icy domain, is found simultaneously with the velocity and pressure.  That is, we solve the coupled system consisting of mass and momentum conservation, including the surface kinematical equation, plus an additional equation for the vertical-only displacement.  This scheme is stated using a time-discretized but continuous-space weak formulation.  At each time step the current domain is the reference configuration on which we compute all quantities.  The corresponding finite element equations, considered in the next section, compute the vertical-only \emph{mesh} displacement simultaneously with the discrete velocity and pressure fields.

Though better implicit schemes exist, we will describe the time-stepping using a backward Euler scheme.  In later work we plan to restate the problem as a differential algebraic equation (DAE) and apply suitable higher-order schemes.
%  Specifically, we will consider the second-order backward-differentiation formula (BDF2) \cite{AscherPetzold1998} and solver tools based on PETSc's \cite{Balayetal2020,BuelerBook} time-stepping TS object.
% possibly \texttt{firedrake-ts}; https://github.com/IvanYashchuk/firedrake-ts

Let $t_{n-1}$ and $t_n$ be consecutive times with step $\Delta t = t_n - t_{n-1} > 0$.  Suppose the model's state, namely the (current) ice geometry, is known at time $t_{n-1}$.  Denote this ice-filled domain as $\Lambda = \Omega^{t_{n-1}} \subset \RR^2$.  We will approximate the updated (new) domain $\Omega^n = \Omega^{t_n} \subset \RR^2$ using the weak form \eqref{weak} of the Glen-Stokes equations, plus a weak form of the surface kinematical equation \eqref{surfacekinematical} (see below), plus input data for the surface mass balance $a(x,z,t)$.  Note that assumption \eqref{intervalassume} needs to hold for $\Lambda$, and, once we have solved all the equations, it must also hold for $\Omega^n$ so that time-stepping may proceed.

The coordinates on the current domain $\Lambda$ are denoted $\bm{\xi}=(r,s)$.  We update the region by computing a change of coordinates $\bm{\xi} = (r,s) \mapsto \bx = (x,z)$,
\begin{equation}
x(r,s)=r, \quad z(r,s)=s+c(r,s), \label{changecoords}
\end{equation}
so the new domain $\Omega^n$ is an image of $\Lambda$,
\begin{equation}
\Omega^n = \{(x,z)=(r,s+c(r,s)) \,\big|\, (r,s) \in \Lambda\}, \label{updateddomain}
\end{equation}
and this $\Lambda \stackrel{\Delta t}{\to} \Omega^n$ domain update is sketched in Figure \ref{fig:domainupdate}.  Note that the horizontal coordinate does not change ($x=r$), but the $z$-coordinate is nontrivial.  Here $c(r,s)$ is a scalar function which will be computed by solving coupled PDEs on $\Lambda$ (below).  Because $c$ will solve an elliptic PDE (below), the new coordinates $x,z$ are smooth functions of $r,s$.

\begin{figure}[h]
FIXME

\caption{The current $t_{n-1}$ domain $\Lambda$ is the reference configuration for the new $t_n$ domain $\Omega^n$.}
\label{fig:domainupdate}
\end{figure}

From \eqref{changecoords} the Jacobian of the coordinate change is
\begin{equation}
J = \begin{pmatrix} \partial x / \partial r & \partial x / \partial s \\ \strut \partial z / \partial r & \partial z / \partial s \end{pmatrix} = \begin{pmatrix} 1 & 0 \\ \partial c/\partial r & 1+(\partial c/\partial s) \end{pmatrix}, \label{jacchange}
\end{equation}
with determinant
\begin{equation}
j(r,s) = 1+\frac{\partial c}{\partial s}. \label{definej}
\end{equation}
For a generic, smooth function $\tilde f(x,z)$ defined on $\Omega^n$ we define a new function on $\Lambda$,
    $$f(r,s) = \tilde f(r,s+c(r,s)),$$
and then partial derivatives transform as
\begin{equation}
\begin{bmatrix} \partial \tilde f / \partial x \\ \strut \partial \tilde f / \partial z\end{bmatrix} = (J^\top)^{-1} \begin{bmatrix} \partial f / \partial r \\ \strut \partial f / \partial s\end{bmatrix} = \begin{pmatrix} 1 & \ell \\ 0 & k \end{pmatrix} \begin{bmatrix} \partial f / \partial r \\ \strut \partial f / \partial s\end{bmatrix} \label{changederivatives}
\end{equation}
where
\begin{equation}
k(r,s) = j(r,s)^{-1}, \qquad \ell(r,s) = - \frac{\partial c}{\partial r}(r,s) j(r,s)^{-1}. \label{definejkl}
\end{equation}

For stability we require that the change of coordinates not cause a local flip in orientation, though degeneration is allowed.  That is, we will require $j\ge 0$ or equivalently
\begin{equation}
\frac{\partial c}{\partial s} \ge -1. \label{differentialVI}
\end{equation}
(We reconsider the meaning of this restriction in Section \ref{sec:inequalities}.)

Let $\eta(r)$ denote the current surface elevation (i.e.~of $\Lambda$).  The new surface elevation, for the region $\Omega^n$, is
\begin{equation}
h(r) = \eta(r) + c(r,\eta(r)).  \label{newsurfaceelevation}
\end{equation}
The value $c(r,\eta(r))$ is defined in a trace sense \cite{Evans2010}; see below for the Sobolev space which contains $c$.  As noted above, we discretize time by the backward Euler method, and so the time derivative $h_t$ in surface kinematical equation \eqref{surfacekinematical} will be approximated by $(h(r) - \eta(r))/\Delta t = c(r,\eta(r))/\Delta t$.  Let
\begin{equation}
a^n(r) = a\left(r,\eta(r) + c(r,\eta(r)),t_n\right) \label{massbalance}
\end{equation}
be the mass balance computed at the updated surface location and the updated time.  We will consider the following two $O(\Delta t)$ approximations of \eqref{surfacekinematical}:
\renewcommand{\labelenumi}{\Alph{enumi}.}
\begin{enumerate}
\item The linearized and semi-implicit choice
\begin{equation}
\frac{c(r,\eta(r))}{\Delta t} = a(r,\eta(r)) - u(r,\eta(r))\,\eta'(r) + w(r,\eta(r)) \label{surfacesemiimplicit}
\end{equation}
where the surface slope and mass balance are computed from the time $t_{n-1}$ surface $s=\eta(r)$.
\item The fully-implicit choice
\begin{equation}
\frac{c(r,\eta(r))}{\Delta t} = a^n(r) - u(r,\eta(r))\,h'(r) + w(r,\eta(r)). \label{surfaceimplicit}
\end{equation}
using the updated surface $s=h(r)$ at time $t_n$.
\end{enumerate}
From \eqref{newsurfaceelevation} we have
    $$h'(r) = \eta'(r) + \grad c (r,\eta(r)) \cdot \left<1,\eta'(r)\right>.$$
Thus the fully-implicit choice B involves a tangential derivative of $c$ along the top boundary of $\Lambda$, and it couples with the determination of the mass balance during the time interval $[t_{n-1},t_n]$.

Finally we can state how the domain update is computed.  We propose that the vertical displacement function $c(r,s)$, defined on the current domain $\Lambda$, solves the Laplace equation along with boundary conditions which include either \eqref{surfacesemiimplicit} or \eqref{surfaceimplicit}.  The strong form of the problem uses either choice A or B on the top surface:
\begin{align}
        \grad^2 c &= 0 &&\emph{in } \Lambda \label{claplace} \\
                c &= \Delta t\,\begin{Bmatrix} a^{n-1} - u \eta' + w \\ a^n - u h' + w \end{Bmatrix} &&\emph{top} \notag \\
                c &= 0 &&\text{\emph{base} \& \emph{inflow}} \notag \\
\grad c\cdot \hbn &= 0 &&\emph{outflow} \notag
\end{align}
where $a^{n-1}(r) = a(r,\eta(r))$.  Note that Dirichlet conditions apply on most of the boundary, but a Neumann condition applies on the outflow (if it is present).

Because it involves the velocity unknowns, we impose the Dirichlet boundary condition along the top surface $\partial_{\text{top}} \Lambda$ weakly.  Let $W_0^{1,2}(\Lambda)$ be the space of $W^{1,2}(\Lambda)$ functions which are zero on the base and inflow.  Noting that the outflow has a natural condition, and assuming that functions $u,w$ are defined on $\overline\Lambda$, define the bilinear form
\begin{equation}
a(c;e) = \int_\Lambda \grad c \cdot \grad e \,dr ds + \int_{\partial_{\text{top}} \Lambda} \left(c - \Delta t\,\begin{Bmatrix} a^{n-1} - u \eta' + w \\ a^n - u h' + w \end{Bmatrix}\right) e\,d\sigma \label{surfaceweakform}
\end{equation}
The integral along $\partial_{\text{top}} \Lambda$, with length element $d\sigma$, evaluates $c$ and $e$ in the trace sense.  In the decoupled case we say that $c \in W_0^{1,2}(\Lambda)$ solves the (decoupled) weak form of \eqref{claplace} if $a(c;e)=0$ for all $e \in W_0^{1,2}(\Lambda)$.

Assuming that $\Lambda$ is a well-behaved domain, this boundary-value problem, which is linear in choice A above, is expected to be well-posed if $u,w$ are given functions.  However, we intend to solve \eqref{claplace} in a coupled context, whether in choice A or B, where the Dirichlet condition on the top couples the computation of $c$ with the nonlinear Glen-Stokes model.  The well-posedness of the coupled equations is not resolved in this paper.



\section{Weak form of the coupled equations} \label{sec:weakformcoupled}

The change of variables defined in the last section requires us to rewrite the weak form integrals of the Glen-Stokes model.  For a generic scalar-valued $L^1$ function $\tilde f(x,z)$ defined on $\Omega^n$, by the change of variables theorem we have
\begin{equation}
\int_{\Omega^n} \tilde f(x,z)\,dx dz = \int_\Lambda f(r,s) \, j(r,s)\,dr ds, \label{changeintegral}
\end{equation}
with weight $j(r,s)$ defined in \eqref{definejkl} and $f(r,s) = \tilde f(r,s+c(r,s))$.  Using component notation $\bu = \left<u_0,u_2\right>$, compatible with coordinate notation $(x,z)$ on $\Omega$, the following expansions of velocity derivatives (strain rates) with respect to $(x,z)$; these formulas follow from \eqref{changederivatives} and \eqref{definejkl}:
\begin{align*}
\grad_{x,z} \cdot \tilde \bu &= \frac{\partial u_0}{\partial r} + \ell \frac{\partial u_0}{\partial s} + k \frac{\partial u_2}{\partial s} \\
D_{x,z} \tilde \bu &= \begin{pmatrix} \partial u_0/\partial r + \ell (\partial u_0/\partial s) & \gamma \\
  \strut \gamma & k (\partial u_2/\partial s)\end{pmatrix} \\
|D_{x,z} \tilde \bu|^2 &= \frac{1}{2}\left(\frac{\partial u_0}{\partial r} + \ell \frac{\partial u_0}{\partial s}\right)^2 + \gamma^2 + \frac{1}{2}\left(k \frac{\partial u_2}{\partial s}\right)^2
\end{align*}
where
    $$\gamma = \frac{1}{2} \left(k \frac{\partial u_0}{\partial s} + \frac{\partial u_2}{\partial r} + \ell \frac{\partial u_2}{\partial s}\right)$$
is a notational simplification only.

From weak forms \eqref{definetildeF} and \eqref{surfaceweakform}, the proposed [DRAFT] weak form is
\begin{align}
F(\bu,p,c;\bv,q,e) &= \int_\Lambda 2 \nu_\eps(|D\bu|)\, D\bu\,:\,D\bv\, j\,dr ds [FIXME] \label{defineF} \\
    &\quad  - \int_\Lambda p \left(j \frac{\partial v_0}{\partial r} - \frac{\partial c}{\partial r} \frac{\partial v_0}{\partial s} + \frac{\partial v_2}{\partial s}\right) \,dr ds \notag \\
    &\quad - \int_\Lambda q \left(j \frac{\partial u_0}{\partial r} - \frac{\partial c}{\partial r} \frac{\partial u_0}{\partial s} + \frac{\partial u_2}{\partial s}\right)\,dr ds \notag \\
    &\quad  - \int_\Lambda \rho \mathbf{g} \cdot \bv \, j\,dr ds \notag \\
    &\quad + \int_{\partial_O \Lambda} \rho (H_{\text{out}}-s-c) \bg \cdot \bv \,dS \notag \\
    &\quad + FIXME: a(c;e) \notag
\end{align}

The solution of the weak form is a list of three functions, $\bu = \left<u_0,u_2\right> \in V_D$, $p\in L^{p'}(\Lambda)$, and $c\in W^{1,2}_0(\Lambda)$, such that $F(\bu,p,c;\bv,q,e) = 0$ for all $\bv = \left<v_0,v_2\right> \in V_0$,  $q\in L^{p'}(\Lambda)$, and $e \in W^{1,2}_0(\Lambda)$.  Note that all trial and test functions are functions of $r$ and $s$ in $\Lambda$.

FIXME result is following block structure


\section{Inequality constraints and mass accounting} \label{sec:inequalities}

\begin{lemma}
Assume that the ice thickness is well defined at time $t_{n-1}$, that is, assume
\eqref{intervalassume}.  If inequality \eqref{differentialVI} holds then the updated ice surface elevation
    $$h(r) = \sup_{s\in I(r)}\{z(r,s)\}$$
satisfies \eqref{admissibility}, i.e.~$h(r)\ge b(r)$.
\end{lemma}

\begin{proof}
FIXME? This is the fundamental theorem of calculus:
    $$h(r) - b(r) = \int_{I(r)} 1\,ds \le \int_{I(r)} - \frac{\partial c}{\partial s}\,ds$$
\end{proof}


\section{Finite element approximation}  \label{sec:finiteelement}

FIXME: numerical solver should check element orientation under change of coordinates (above); if the solver flips an element then it is bad; also check new element aspect ratio and (presumably) remesh if that is bad; the initial iterate for the (SNES-based) solver is clear: $\bu,p$ come from solution of previous time step, and $b$ starts at zero



\small

\bigskip
\bibliography{simp}
\bibliographystyle{siam}

\end{document}
